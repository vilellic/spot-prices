import fetchMock from 'jest-fetch-mock';
import rootController from './rootController';
import NodeCache from 'node-cache';
import constants from '../types/constants';
fetchMock.enableMocks();

const fixedFakeDate = new Date('2024-12-04').setHours(15);
jest.useFakeTimers().setSystemTime(fixedFakeDate);

test('Parse Elering API response store to cache and check contents', async () => {
  // https://dashboard.elering.ee/api/nps/price?start=2024-12-02T22:00:00.000Z&end=2024-12-05T21:59:59.999Z

  fetchMock.mockResponse(
    JSON.stringify({
      success: true,
      data: {
        fi: [
          {
            timestamp: 1733176800,
            price: 24.99,
          },
          {
            timestamp: 1733180400,
            price: 24,
          },
          {
            timestamp: 1733184000,
            price: 23.99,
          },
          {
            timestamp: 1733187600,
            price: 8.9,
          },
          {
            timestamp: 1733191200,
            price: 8.28,
          },
          {
            timestamp: 1733194800,
            price: 18.94,
          },
          {
            timestamp: 1733198400,
            price: 49.57,
          },
          {
            timestamp: 1733202000,
            price: 67.63,
          },
          {
            timestamp: 1733205600,
            price: 142.48,
          },
          {
            timestamp: 1733209200,
            price: 155,
          },
          {
            timestamp: 1733212800,
            price: 144.63,
          },
          {
            timestamp: 1733216400,
            price: 127.55,
          },
          {
            timestamp: 1733220000,
            price: 144.96,
          },
          {
            timestamp: 1733223600,
            price: 124.93,
          },
          {
            timestamp: 1733227200,
            price: 158.03,
          },
          {
            timestamp: 1733230800,
            price: 119.93,
          },
          {
            timestamp: 1733234400,
            price: 95.12,
          },
          {
            timestamp: 1733238000,
            price: 97.22,
          },
          {
            timestamp: 1733241600,
            price: 182.57,
          },
          {
            timestamp: 1733245200,
            price: 168.77,
          },
          {
            timestamp: 1733248800,
            price: 158.47,
          },
          {
            timestamp: 1733252400,
            price: 124.96,
          },
          {
            timestamp: 1733256000,
            price: 119.74,
          },
          {
            timestamp: 1733259600,
            price: 82.66,
          },
          {
            timestamp: 1733263200,
            price: 47.52,
          },
          {
            timestamp: 1733266800,
            price: 35.51,
          },
          {
            timestamp: 1733270400,
            price: 38.63,
          },
          {
            timestamp: 1733274000,
            price: 41.12,
          },
          {
            timestamp: 1733277600,
            price: 48.09,
          },
          {
            timestamp: 1733281200,
            price: 58.75,
          },
          {
            timestamp: 1733284800,
            price: 71.35,
          },
          {
            timestamp: 1733288400,
            price: 137.8,
          },
          {
            timestamp: 1733292000,
            price: 214.04,
          },
          {
            timestamp: 1733295600,
            price: 272.79,
          },
          {
            timestamp: 1733299200,
            price: 248.23,
          },
          {
            timestamp: 1733302800,
            price: 216.28,
          },
          {
            timestamp: 1733306400,
            price: 202.75,
          },
          {
            timestamp: 1733310000,
            price: 206.43,
          },
          {
            timestamp: 1733313600,
            price: 179.69,
          },
          {
            timestamp: 1733317200,
            price: 162.59,
          },
          {
            timestamp: 1733320800,
            price: 171.59,
          },
          {
            timestamp: 1733324400,
            price: 171.51,
          },
          {
            timestamp: 1733328000,
            price: 154.71,
          },
          {
            timestamp: 1733331600,
            price: 140.18,
          },
          {
            timestamp: 1733335200,
            price: 88.33,
          },
          {
            timestamp: 1733338800,
            price: 79.23,
          },
          {
            timestamp: 1733342400,
            price: 78.06,
          },
          {
            timestamp: 1733346000,
            price: 47.49,
          },
          {
            timestamp: 1733349600,
            price: 26.18,
          },
        ],
      },
    }),
    { status: 200 },
  );

  const nodeCache = new NodeCache();
  await rootController.updatePrices(nodeCache);

  // today
  expect(fetch).toHaveBeenNthCalledWith(
    1,
    'https://dashboard.elering.ee/api/nps/price?start=2024-12-02T22:00:00.000Z&end=2024-12-05T21:59:59.999Z',
    { method: 'Get' },
  );

  console.log(JSON.stringify(nodeCache.get(constants.CACHED_NAME_PRICES), null, 2));

  expect(nodeCache.get(constants.CACHED_NAME_PRICES)).toStrictEqual({
    prices: [
      {
        start: '2024-11-26T00:00:00.000+02:00',
        price: 0.00206,
      },
      {
        start: '2024-11-26T01:00:00.000+02:00',
        price: 0.00001,
      },
      {
        start: '2024-11-26T02:00:00.000+02:00',
        price: -0.00001,
      },
      {
        start: '2024-11-26T03:00:00.000+02:00',
        price: 0,
      },
      {
        start: '2024-11-26T04:00:00.000+02:00',
        price: -0.00001,
      },
      {
        start: '2024-11-26T05:00:00.000+02:00',
        price: 0,
      },
      {
        start: '2024-11-26T06:00:00.000+02:00',
        price: 0.00254,
      },
      {
        start: '2024-11-26T07:00:00.000+02:00',
        price: 0.00648,
      },
      {
        start: '2024-11-26T08:00:00.000+02:00',
        price: 0.00802,
      },
      {
        start: '2024-11-26T09:00:00.000+02:00',
        price: 0.01052,
      },
      {
        start: '2024-11-26T10:00:00.000+02:00',
        price: 0.01122,
      },
      {
        start: '2024-11-26T11:00:00.000+02:00',
        price: 0.01471,
      },
      {
        start: '2024-11-26T12:00:00.000+02:00',
        price: 0.01915,
      },
      {
        start: '2024-11-26T13:00:00.000+02:00',
        price: 0.01835,
      },
      {
        start: '2024-11-26T14:00:00.000+02:00',
        price: 0.02057,
      },
      {
        start: '2024-11-26T15:00:00.000+02:00',
        price: 0.02364,
      },
      {
        start: '2024-11-26T16:00:00.000+02:00',
        price: 0.03154,
      },
      {
        start: '2024-11-26T17:00:00.000+02:00',
        price: 0.04115,
      },
      {
        start: '2024-11-26T18:00:00.000+02:00',
        price: 0.05179,
      },
      {
        start: '2024-11-26T19:00:00.000+02:00',
        price: 0.05521,
      },
      {
        start: '2024-11-26T20:00:00.000+02:00',
        price: 0.04892,
      },
      {
        start: '2024-11-26T21:00:00.000+02:00',
        price: 0.04404,
      },
      {
        start: '2024-11-26T22:00:00.000+02:00',
        price: 0.05122,
      },
      {
        start: '2024-11-26T23:00:00.000+02:00',
        price: 0.04133,
      },
      {
        start: '2024-11-27T00:00:00.000+02:00',
        price: 0.03489,
      },
      {
        start: '2024-11-27T01:00:00.000+02:00',
        price: 0.04498,
      },
      {
        start: '2024-11-27T02:00:00.000+02:00',
        price: 0.04147,
      },
      {
        start: '2024-11-27T03:00:00.000+02:00',
        price: 0.04337,
      },
      {
        start: '2024-11-27T04:00:00.000+02:00',
        price: 0.04626,
      },
      {
        start: '2024-11-27T05:00:00.000+02:00',
        price: 0.05276,
      },
      {
        start: '2024-11-27T06:00:00.000+02:00',
        price: 0.08029,
      },
      {
        start: '2024-11-27T07:00:00.000+02:00',
        price: 0.21466,
      },
      {
        start: '2024-11-27T08:00:00.000+02:00',
        price: 0.23352,
      },
      {
        start: '2024-11-27T09:00:00.000+02:00',
        price: 0.23844,
      },
      {
        start: '2024-11-27T10:00:00.000+02:00',
        price: 0.22049,
      },
      {
        start: '2024-11-27T11:00:00.000+02:00',
        price: 0.20184,
      },
      {
        start: '2024-11-27T12:00:00.000+02:00',
        price: 0.20152,
      },
      {
        start: '2024-11-27T13:00:00.000+02:00',
        price: 0.1999,
      },
      {
        start: '2024-11-27T14:00:00.000+02:00',
        price: 0.19588,
      },
      {
        start: '2024-11-27T15:00:00.000+02:00',
        price: 0.19587,
      },
      {
        start: '2024-11-27T16:00:00.000+02:00',
        price: 0.25099,
      },
      {
        start: '2024-11-27T17:00:00.000+02:00',
        price: 0.25108,
      },
      {
        start: '2024-11-27T18:00:00.000+02:00',
        price: 0.20876,
      },
      {
        start: '2024-11-27T19:00:00.000+02:00',
        price: 0.15527,
      },
      {
        start: '2024-11-27T20:00:00.000+02:00',
        price: 0.14001,
      },
      {
        start: '2024-11-27T21:00:00.000+02:00',
        price: 0.10669,
      },
      {
        start: '2024-11-27T22:00:00.000+02:00',
        price: 0.09795,
      },
      {
        start: '2024-11-27T23:00:00.000+02:00',
        price: 0.0908,
      },
      {
        start: '2024-11-28T00:00:00.000+02:00',
        price: 0.06906,
      },
      {
        start: '2024-11-28T01:00:00.000+02:00',
        price: 0.06931,
      },
      {
        start: '2024-11-28T02:00:00.000+02:00',
        price: 0.05915,
      },
      {
        start: '2024-11-28T03:00:00.000+02:00',
        price: 0.04517,
      },
      {
        start: '2024-11-28T04:00:00.000+02:00',
        price: 0.04339,
      },
      {
        start: '2024-11-28T05:00:00.000+02:00',
        price: 0.0508,
      },
      {
        start: '2024-11-28T06:00:00.000+02:00',
        price: 0.06732,
      },
      {
        start: '2024-11-28T07:00:00.000+02:00',
        price: 0.16307,
      },
      {
        start: '2024-11-28T08:00:00.000+02:00',
        price: 0.18082,
      },
      {
        start: '2024-11-28T09:00:00.000+02:00',
        price: 0.18077,
      },
      {
        start: '2024-11-28T10:00:00.000+02:00',
        price: 0.18083,
      },
      {
        start: '2024-11-28T11:00:00.000+02:00',
        price: 0.18083,
      },
      {
        start: '2024-11-28T12:00:00.000+02:00',
        price: 0.20332,
      },
      {
        start: '2024-11-28T13:00:00.000+02:00',
        price: 0.20404,
      },
      {
        start: '2024-11-28T14:00:00.000+02:00',
        price: 0.21227,
      },
      {
        start: '2024-11-28T15:00:00.000+02:00',
        price: 0.19788,
      },
      {
        start: '2024-11-28T16:00:00.000+02:00',
        price: 0.21772,
      },
      {
        start: '2024-11-28T17:00:00.000+02:00',
        price: 0.19966,
      },
      {
        start: '2024-11-28T18:00:00.000+02:00',
        price: 0.22085,
      },
      {
        start: '2024-11-28T19:00:00.000+02:00',
        price: 0.20699,
      },
      {
        start: '2024-11-28T20:00:00.000+02:00',
        price: 0.2014,
      },
      {
        start: '2024-11-28T21:00:00.000+02:00',
        price: 0.18085,
      },
      {
        start: '2024-11-28T22:00:00.000+02:00',
        price: 0.16592,
      },
      {
        start: '2024-11-28T23:00:00.000+02:00',
        price: 0.14232,
      },
    ],
  });

  expect(await rootController.handleRoot({ cache: nodeCache })).toStrictEqual({
    info: {
      current: '0.04147',
      averageToday: '0.14782',
      averageTodayOffPeak: '0.04851',
      averageTodayPeak: '0.20099',
      tomorrowAvailable: true,
      averageTomorrow: '0.15182',
      averageTomorrowOffPeak: '0.06588',
      averageTomorrowPeak: '0.19542',
    },
    today: [
      {
        start: '2024-11-27T00:00:00.000+02:00',
        price: '0.03489',
      },
      {
        start: '2024-11-27T01:00:00.000+02:00',
        price: '0.04498',
      },
      {
        start: '2024-11-27T02:00:00.000+02:00',
        price: '0.04147',
      },
      {
        start: '2024-11-27T03:00:00.000+02:00',
        price: '0.04337',
      },
      {
        start: '2024-11-27T04:00:00.000+02:00',
        price: '0.04626',
      },
      {
        start: '2024-11-27T05:00:00.000+02:00',
        price: '0.05276',
      },
      {
        start: '2024-11-27T06:00:00.000+02:00',
        price: '0.08029',
      },
      {
        start: '2024-11-27T07:00:00.000+02:00',
        price: '0.21466',
      },
      {
        start: '2024-11-27T08:00:00.000+02:00',
        price: '0.23352',
      },
      {
        start: '2024-11-27T09:00:00.000+02:00',
        price: '0.23844',
      },
      {
        start: '2024-11-27T10:00:00.000+02:00',
        price: '0.22049',
      },
      {
        start: '2024-11-27T11:00:00.000+02:00',
        price: '0.20184',
      },
      {
        start: '2024-11-27T12:00:00.000+02:00',
        price: '0.20152',
      },
      {
        start: '2024-11-27T13:00:00.000+02:00',
        price: '0.19990',
      },
      {
        start: '2024-11-27T14:00:00.000+02:00',
        price: '0.19588',
      },
      {
        start: '2024-11-27T15:00:00.000+02:00',
        price: '0.19587',
      },
      {
        start: '2024-11-27T16:00:00.000+02:00',
        price: '0.25099',
      },
      {
        start: '2024-11-27T17:00:00.000+02:00',
        price: '0.25108',
      },
      {
        start: '2024-11-27T18:00:00.000+02:00',
        price: '0.20876',
      },
      {
        start: '2024-11-27T19:00:00.000+02:00',
        price: '0.15527',
      },
      {
        start: '2024-11-27T20:00:00.000+02:00',
        price: '0.14001',
      },
      {
        start: '2024-11-27T21:00:00.000+02:00',
        price: '0.10669',
      },
      {
        start: '2024-11-27T22:00:00.000+02:00',
        price: '0.09795',
      },
      {
        start: '2024-11-27T23:00:00.000+02:00',
        price: '0.09080',
      },
    ],
    tomorrow: [
      {
        start: '2024-11-28T00:00:00.000+02:00',
        price: '0.06906',
      },
      {
        start: '2024-11-28T01:00:00.000+02:00',
        price: '0.06931',
      },
      {
        start: '2024-11-28T02:00:00.000+02:00',
        price: '0.05915',
      },
      {
        start: '2024-11-28T03:00:00.000+02:00',
        price: '0.04517',
      },
      {
        start: '2024-11-28T04:00:00.000+02:00',
        price: '0.04339',
      },
      {
        start: '2024-11-28T05:00:00.000+02:00',
        price: '0.05080',
      },
      {
        start: '2024-11-28T06:00:00.000+02:00',
        price: '0.06732',
      },
      {
        start: '2024-11-28T07:00:00.000+02:00',
        price: '0.16307',
      },
      {
        start: '2024-11-28T08:00:00.000+02:00',
        price: '0.18082',
      },
      {
        start: '2024-11-28T09:00:00.000+02:00',
        price: '0.18077',
      },
      {
        start: '2024-11-28T10:00:00.000+02:00',
        price: '0.18083',
      },
      {
        start: '2024-11-28T11:00:00.000+02:00',
        price: '0.18083',
      },
      {
        start: '2024-11-28T12:00:00.000+02:00',
        price: '0.20332',
      },
      {
        start: '2024-11-28T13:00:00.000+02:00',
        price: '0.20404',
      },
      {
        start: '2024-11-28T14:00:00.000+02:00',
        price: '0.21227',
      },
      {
        start: '2024-11-28T15:00:00.000+02:00',
        price: '0.19788',
      },
      {
        start: '2024-11-28T16:00:00.000+02:00',
        price: '0.21772',
      },
      {
        start: '2024-11-28T17:00:00.000+02:00',
        price: '0.19966',
      },
      {
        start: '2024-11-28T18:00:00.000+02:00',
        price: '0.22085',
      },
      {
        start: '2024-11-28T19:00:00.000+02:00',
        price: '0.20699',
      },
      {
        start: '2024-11-28T20:00:00.000+02:00',
        price: '0.20140',
      },
      {
        start: '2024-11-28T21:00:00.000+02:00',
        price: '0.18085',
      },
      {
        start: '2024-11-28T22:00:00.000+02:00',
        price: '0.16592',
      },
      {
        start: '2024-11-28T23:00:00.000+02:00',
        price: '0.14232',
      },
    ],
  });
});
